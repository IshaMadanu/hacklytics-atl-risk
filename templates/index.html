<!DOCTYPE html>
<html>
<head>
    <title>Atlanta Risk Map</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <style>
        body { margin: 0; font-family: Arial, sans-serif; }
        #controls {
            padding: 10px 16px;
            background: #1a1a2e;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        #controls h2 { margin: 0; font-size: 18px; }
        #address {
            flex: 1;
            padding: 7px 12px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
        }
        #time-input {
            padding: 7px 10px;
            border-radius: 6px;
            border: none;
            font-size: 14px;
            background: #16213e;
            color: white;
            color-scheme: dark;
            width: 130px;
        }
        #watch-label {
            font-size: 12px;
            color: #aaa;
            white-space: nowrap;
        }
        #controls button {
            padding: 7px 16px;
            background: #e94560;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
        }
        #controls button:hover { background: #c73652; }

                #controls button:hover { background: #c73652; }

        /* Nav button */
        #nav-btn {
            padding: 7px 16px;
            background: linear-gradient(90deg, #c77dff, #ff6b6b) !important;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            white-space: nowrap;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-family: Arial, sans-serif;
        }
        #nav-btn:hover { opacity: 0.85; }

        #map { height: calc(100vh - 52px); }

        /* Custom marker icons ‚Äî rendered as styled divs, not emoji */
        .icon-dot {
            border-radius: 50%;
            border: 2px solid rgba(255,255,255,0.8);
            box-shadow: 0 1px 4px rgba(0,0,0,0.5);
        }
        .icon-square {
            border: 2px solid rgba(255,255,255,0.8);
            border-radius: 3px;
            box-shadow: 0 1px 4px rgba(0,0,0,0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 10px;
            font-weight: bold;
            color: white;
            line-height: 1;
        }

        /* Nearest Resources Panel */
        #resources-panel {
            display: none;
            position: absolute;
            bottom: 30px;
            right: 10px;
            z-index: 1000;
            background: #1a1a2e;
            color: white;
            border-radius: 10px;
            padding: 14px 16px;
            min-width: 280px;
            max-width: 320px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
            font-size: 13px;
        }
        #resources-panel h3 {
            margin: 0 0 10px 0;
            font-size: 14px;
            color: #e94560;
            border-bottom: 1px solid #2a2a4e;
            padding-bottom: 6px;
        }
        .resource-item {
            margin-bottom: 10px;
            padding-bottom: 10px;
            border-bottom: 1px solid #2a2a4e;
        }
        .resource-item:last-child { border-bottom: none; margin-bottom: 0; padding-bottom: 0; }
        .resource-type {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: #aaa;
            margin-bottom: 2px;
        }
        .resource-name { font-weight: bold; color: #fff; margin-bottom: 2px; }
        .resource-addr { color: #aaa; font-size: 12px; margin-bottom: 4px; }
        .resource-phone {
            display: inline-block;
            background: #e94560;
            color: white;
            padding: 3px 10px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: bold;
            text-decoration: none;
        }
        .resource-phone:hover { background: #c73652; }
        .resource-phone.green { background: #00b894; }
        .resource-phone.green:hover { background: #00a382; }
        .resource-phone.blue { background: #3498db; }
        .resource-phone.blue:hover { background: #2380c0; }
        .resource-dist { color: #888; font-size: 11px; margin-left: 6px; }
    </style>
</head>
<body>

<div id="controls">
    <h2>üó∫Ô∏è Atlanta Risk Map</h2>
    <input type="text" id="address" placeholder="Enter an address to check risk...">
    <input type="time" id="time-input" value="17:00" oninput="updateWatchLabel()">
    <span id="watch-label">üåÜ Day Watch ¬∑ 12:00PM‚Äì7:59PM</span>
    <button onclick="checkRisk()">Check Risk</button>
    <a href="/chatanalyzer" id="nav-btn">üö© VibeCheck</a>
</div>

<div id="map"></div>
<div id="resources-panel"></div>

<script>
    var map = L.map('map').setView([33.7490, -84.3880], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // -----------------------------------------------
    // Icon factory ‚Äî avoids emoji rendering issues
    // -----------------------------------------------
    function makeDotIcon(color) {
        return L.divIcon({
            className: 'icon-dot',
            html: '<div style="width:12px;height:12px;background:' + color + ';border-radius:50%;border:2px solid rgba(255,255,255,0.85);box-shadow:0 1px 4px rgba(0,0,0,0.55);"></div>',
            iconSize: [12, 12],
            iconAnchor: [6, 6],
            popupAnchor: [0, -10]
        });
    }

    function makeSquareIcon(color, letter) {
        return L.divIcon({
            className: '',
            html: '<div style="width:16px;height:16px;background:' + color + ';border:2px solid rgba(255,255,255,0.85);border-radius:3px;box-shadow:0 1px 4px rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;color:white;line-height:1;">' + letter + '</div>',
            iconSize: [16, 16],
            iconAnchor: [8, 8],
            popupAnchor: [0, -10]
        });
    }

    function makeSquareIconHTML(color, letter) {
    return `
        <div style="
            display:inline-flex;
            align-items:center;
            justify-content:center;
            width:16px;
            height:16px;
            background:${color};
            border:2px solid rgba(255,255,255,0.85);
            border-radius:3px;
            box-shadow:0 1px 4px rgba(0,0,0,0.55);
            font-size:9px;
            font-weight:bold;
            color:white;
            margin-right:6px;
        ">${letter}</div>
    `;
}

    // -----------------------------------------------
    // Sex Offender Markers
    // -----------------------------------------------
    var offenderLayer = L.layerGroup().addTo(map);
    var offenders = {{ offenders|tojson }};
    var offenderIcon = makeDotIcon('#ff6b35');

    offenders.forEach(function(o) {
        var lat = parseFloat(o.LATITUDE), lon = parseFloat(o.LONGITUDE);
        if (!isNaN(lat) && !isNaN(lon)) {
            L.marker([lat, lon], { icon: offenderIcon })
             .bindPopup(
                "<b>" + (o.NAME || "Unknown") + "</b>" +
                "<br>Level: " + (o.LEVELING || "N/A") +
                "<br>Crime: " + (o.CRIME || "N/A") +
                "<br>City: " + (o.CITY || "N/A")
             )
             .addTo(offenderLayer);
        }
    });

    // -----------------------------------------------
    // Fire Stations ‚Äî FIX: was using emoji divIcon unreliably
    // -----------------------------------------------
    var fireLayer = L.layerGroup().addTo(map);  // added to map by default
    var fireData = [];
    var fireIcon = makeSquareIcon('#e94560', 'F');

    fetch('/static/fire_stations.json').then(r => r.json()).then(function(data) {
        fireData = data;
        data.forEach(function(s) {
            L.marker([s.lat, s.lon], { icon: fireIcon })
             .bindPopup(
                "<b>" + s.name + "</b><br>" + s.address +
                "<br><a href='tel:" + s.phone + "' style='color:#e94560;font-weight:bold;'>üìû " + s.phone + "</a>"
             )
             .addTo(fireLayer);
        });
    }).catch(function(e) { console.warn('fire_stations.json failed to load:', e); });

    // -----------------------------------------------
    // Healthcare ‚Äî FIX: was missing .addTo(map), layer was never visible
    // -----------------------------------------------
    var healthLayer = L.layerGroup().addTo(map);  // ‚Üê was missing .addTo(map)
    var healthData = [];
    var healthIcon = makeDotIcon('#00b894');

    fetch('/static/healthcare.json').then(r => r.json()).then(function(data) {
        healthData = data;
        data.forEach(function(h) {
            L.marker([h.lat, h.lon], { icon: healthIcon })
             .bindPopup(
                "<b>" + h.name + "</b><br><i>" + h.category + "</i><br>" + h.address +
                "<br><a href='tel:" + h.phone + "' style='color:#00b894;font-weight:bold;'>üìû " + h.phone + "</a>"
             )
             .addTo(healthLayer);
        });
    }).catch(function(e) { console.warn('healthcare.json failed to load:', e); });

    // -----------------------------------------------
    // APD Zones ‚Äî GeoJSON boundaries + station markers
    // FIX: pdZones entries need lat/lon for nearest() to work;
    //      now we place a visible marker for each zone station too.
    // -----------------------------------------------
    var zoneLayer = L.layerGroup().addTo(map);
    var pdZones = [];
    var zoneColors = ["#e94560","#f39c12","#3498db","#9b59b6","#1abc9c","#e67e22","#e74c3c"];
    var pdIcon = makeSquareIcon('#3498db', 'P');

    fetch('/static/pd_zones.json').then(r => r.json()).then(function(data) {
        pdZones = data;

        // Place a visible marker for each zone's station (requires lat/lon in pd_zones.json)
        data.forEach(function(z) {
            // Only place marker if lat/lon are present in the JSON
            if (z.lat != null && z.lon != null) {
                L.marker([z.lat, z.lon], { icon: pdIcon })
                 .bindPopup(
                    "<b>APD Zone " + z.zone + "</b><br>" + (z.name || '') +
                    "<br><a href='tel:" + z.phone + "' style='color:#3498db;font-weight:bold;'>üìû " + z.phone + " (Non-emergency)</a>" +
                    "<br><a href='tel:911' style='color:#e94560;font-weight:bold;'>üìû 911 (Emergency)</a>"
                 )
                 .addTo(zoneLayer);
            }
        });
    }).catch(function(e) { console.warn('pd_zones.json failed to load:', e); });

    fetch('/static/apd_zones.geojson').then(r => r.json()).then(function(geo) {
        L.geoJSON(geo, {
            style: function(feature) {
                var idx = (feature.properties.Zone_Num || 1) - 1;
                return { color: zoneColors[idx % zoneColors.length], weight: 2, fillOpacity: 0.07 };
            },
            onEachFeature: function(feature, layer) {
                var zn = feature.properties.Zone_Num;
                var pd = pdZones.find(function(z) { return z.zone === zn; }) || {};
                var phone = pd.phone || "404-614-6544";
                var name  = pd.name  || feature.properties.ZONE_DESC;
                layer.bindPopup(
                    "<b>APD Zone " + zn + "</b><br>" + name +
                    "<br><a href='tel:" + phone + "' style='color:#3498db;font-weight:bold;'>üìû " + phone + " (Non-emergency)</a>" +
                    "<br><a href='tel:911' style='color:#e94560;font-weight:bold;'>üìû 911 (Emergency)</a>"
                );
            }
        }).addTo(zoneLayer);
    }).catch(function(e) { console.warn('apd_zones.geojson failed to load:', e); });

    // -----------------------------------------------
    // Layer Toggle
    // -----------------------------------------------
var overlays = {
    '<div style="display:inline-flex;align-items:center;gap:6px;"><div style="width:12px;height:12px;background:#ff6b35;border-radius:50%;border:2px solid rgba(255,255,255,0.85);box-shadow:0 1px 4px rgba(0,0,0,0.55);"></div> Sex Offenders</div>': offenderLayer,
    '<div style="display:inline-flex;align-items:center;gap:6px;"><div style="width:16px;height:16px;background:#e94560;border:2px solid rgba(255,255,255,0.85);border-radius:3px;box-shadow:0 1px 4px rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;color:white;">F</div> Fire Stations</div>': fireLayer,
    '<div style="display:inline-flex;align-items:center;gap:6px;"><div style="width:12px;height:12px;background:#00b894;border-radius:50%;border:2px solid rgba(255,255,255,0.85);box-shadow:0 1px 4px rgba(0,0,0,0.55);"></div> Healthcare</div>': healthLayer,
    '<div style="display:inline-flex;align-items:center;gap:6px;"><div style="width:16px;height:16px;background:#3498db;border:2px solid rgba(255,255,255,0.85);border-radius:3px;box-shadow:0 1px 4px rgba(0,0,0,0.55);display:flex;align-items:center;justify-content:center;font-size:9px;font-weight:bold;color:white;">P</div> APD Zones</div>': zoneLayer
};

L.control.layers(null, overlays, { collapsed: false }).addTo(map);
    // -----------------------------------------------
    // Time / Watch
    // -----------------------------------------------
   function getWatch(hour) {
       if (hour >= 3  && hour <= 12) return { label: "‚òÄÔ∏è Morning Watch ¬∑ 3:00AM‚Äì11:59AM",      text: "Morning Watch" };
       if (hour >= 13 && hour <= 20) return { label: "üåÜ Day Watch ¬∑ 12:00PM‚Äì7:59PM",  text: "Day Watch" };
       return                               { label: "üåô Evening Watch ¬∑ 8:00PM‚Äì2:59AM",  text: "Evening Watch" };
   }
    function updateWatchLabel() {
        var val = document.getElementById("time-input").value;
        if (!val) return;
        document.getElementById("watch-label").textContent = getWatch(parseInt(val.split(":")[0])).label;
    }

    // -----------------------------------------------
    // Nearest Resource Helper
    // -----------------------------------------------
    function haversine(lat1, lon1, lat2, lon2) {
        var R = 6371,
            dLat = (lat2 - lat1) * Math.PI / 180,
            dLon = (lon2 - lon1) * Math.PI / 180;
        var a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
        return R * 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    }

    function nearest(data, lat, lon) {
        var best = null, bestDist = Infinity;
        data.forEach(function(item) {
            // Guard: skip items without lat/lon
            if (item.lat == null || item.lon == null) return;
            var d = haversine(lat, lon, item.lat, item.lon);
            if (d < bestDist) { bestDist = d; best = item; }
        });
        return best ? { item: best, dist: bestDist } : null;
    }

    function showResources(lat, lon) {
        var fire   = nearest(fireData,   lat, lon);
        var health = nearest(healthData, lat, lon);
        var pd     = nearest(pdZones,    lat, lon);  // needs lat/lon in pd_zones.json

        var html = "<h3>üìç Nearest Resources</h3>";

        if (fire)
            html += '<div class="resource-item">' +
                    '<div class="resource-type">üî• Fire / EMS</div>' +
                    '<div class="resource-name">' + fire.item.name + '</div>' +
                    '<div class="resource-addr">' + fire.item.address + '</div>' +
                    '<a class="resource-phone" href="tel:' + fire.item.phone + '">üìû ' + fire.item.phone + '</a>' +
                    '<span class="resource-dist">' + fire.dist.toFixed(2) + ' km away</span>' +
                    '</div>';

        if (health)
            html += '<div class="resource-item">' +
                    '<div class="resource-type">üè• Healthcare ¬∑ ' + health.item.category + '</div>' +
                    '<div class="resource-name">' + health.item.name + '</div>' +
                    '<div class="resource-addr">' + health.item.address + '</div>' +
                    '<a class="resource-phone green" href="tel:' + health.item.phone + '">üìû ' + health.item.phone + '</a>' +
                    '<span class="resource-dist">' + health.dist.toFixed(2) + ' km away</span>' +
                    '</div>';

        if (pd)
            html += '<div class="resource-item">' +
                    '<div class="resource-type">üöî Police (Non-Emergency)</div>' +
                    '<div class="resource-name">APD Zone ' + pd.item.zone + ' ¬∑ ' + (pd.item.name || '') + '</div>' +
                    '<a class="resource-phone blue" href="tel:' + pd.item.phone + '">üìû ' + pd.item.phone + '</a>' +
                    '<span class="resource-dist">' + pd.dist.toFixed(2) + ' km away</span>' +
                    '</div>';

        html += '<div class="resource-item" style="border:none;padding:0;margin-top:4px;">' +
                '<div class="resource-type">üö® Emergency</div>' +
                '<a class="resource-phone" href="tel:911">üìû Call 911</a>' +
                '</div>';

        var panel = document.getElementById("resources-panel");
        panel.innerHTML = html;
        panel.style.display = "block";
    }

    // -----------------------------------------------
    // Risk Check
    // -----------------------------------------------
    function checkRisk() {
        var address = document.getElementById("address").value;
        var timeVal = document.getElementById("time-input").value;
        var hour    = timeVal ? parseInt(timeVal.split(":")[0]) : 17;
        var watch   = getWatch(hour).text;

        fetch('/risk?address=' + encodeURIComponent(address) + '&time=' + encodeURIComponent(watch))
            .then(res => res.json())
            .then(data => {
                if (data.error) { alert("Error: " + data.error); return; }
                var lat  = data.latitude,
                    lon  = data.longitude,
                    risk = data.risk_score;
                var color = risk > 70 ? "red" : risk > 40 ? "orange" : "green";
                L.circle([lat, lon], { color: color, fillColor: color, fillOpacity: 0.25, radius: 250 })
                 .addTo(map)
                 .bindPopup(
                    "<b>" + address + "</b><br>Risk Score: <b>" + risk + "</b>" +
                    "<br>Nearby Crimes: " + data.nearby_crimes +
                    "<br>Watch: " + watch
                 )
                 .openPopup();
                map.setView([lat, lon], 15);
                showResources(lat, lon);
            })
            .catch(err => alert("Request failed: " + err));
    }

    document.getElementById("address").addEventListener("keypress", function(e) {
        if (e.key === "Enter") checkRisk();
    });
</script>
</body>
</html>